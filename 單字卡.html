<!DOCTYPE html> 
<html lang="UTF-8">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單字配對</title>
    <link rel="icon" href="https://www.svgrepo.com/show/335618/quiz-submissions.svg">
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark-mode {
            background-color: #333;
            color: #f4f4f9;
        }
        .game-container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark-mode .game-container {
            background: #444;
            color: #fff;
        }
        .instructions {
            margin-bottom: 20px;
        }
        .words, .targets {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .word, .target {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #e0e0e0;
            cursor: pointer;
            user-select: none;
            text-align: center;
            width: 120px;
            transition: background-color 0.3s, color 0.3s;
            position: relative;
        }
        .word.used {
            background: #d3d3d3;
            color: #999;
            cursor: not-allowed;
        }
        body.dark-mode .word.used {
            background: #555;
            color: #777;
        }
        body.dark-mode .word, body.dark-mode .target {
            background: #555;
            border-color: #777;
            color: #fff;
        }
        .target {
            background: #f9f9f9;
            border: 2px dashed #ccc;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .target .moved-word {
            font-weight: bold;
        }
        .target .original-translation {
            font-size: 0.9em;
            color: gray;
        }
        .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            display: none;
            cursor: pointer;
        }
        .target.has-word:hover .delete-btn {
            display: block;
        }
        body.dark-mode .target .original-translation {
            color: lightgray;
        }
        .target.correct {
            border-color: green;
        }
        .target.incorrect {
            border-color: red;
        }
        .selected {
            background: #add8e6;
        }
        body.dark-mode .selected {
            background: #87ceeb;
            color: #000;
        }
        .buttons {
            margin-top: 10px;
        }
        .button {
            display: inline-block;
            margin: 5px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        .button:hover {
            background-color: #0056b3;
        }
        body.dark-mode .button {
            background-color: #555;
            color: #fff;
        }
        body.dark-mode .button:hover {
            background-color: #777;
        }
        .result, .answers {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }
        .result {
            background: #ffe0e0;
            border: 1px solid #d8b2b2;
        }
        .answers {
            background: #e0ffe0;
            border: 1px solid #b2d8b2;
        }
        body.dark-mode .result {
            background: #444;
            border-color: #777;
            color: #fff;
        }
        body.dark-mode .answers {
            background: #555;
            border-color: #777;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 id="title">多輪配對遊戲</h1>
        <p class="instructions" id="instructions">點擊或拖放英文單詞到對應的中文翻譯區域。</p>
        <div class="words">
            <!-- 英文單詞 -->
        </div>
        <div class="targets">
            <!-- 中文翻譯目標 -->
        </div>
        <div class="buttons">
            <button class="button" onclick="toggleDarkMode()" id="dark-mode-btn">切換深色/淡色模式</button>
            <button class="button" onclick="undoLastAction()" id="undo-btn">撤銷</button>
            <button class="button" id="submit-btn" onclick="checkAnswers()" disabled>提交</button>
            <button id="next-round-btn" class="button" onclick="nextRound()" style="display:none;">下一輪</button>
            <button id="wordbank-btn" class="button" onclick="openWordBank()">查看單字庫</button>
            <button class="button" onclick="switchLanguage('zh')">中文</button>
            <button class="button" onclick="switchLanguage('en')">English</button>
            <button id="restart-btn" class="button" onclick="restartGame()" style="display:none;">再玩一次</button>
            
</div>
        </div>
        <div id="result" class="result" style="display:none;"></div>
        <div id="answers" class="answers" style="display:none;"></div>
    </div>

    <script>
        let currentLanguage = 'zh'; // 預設語言

        const translations = {
          zh: {
            title: "多輪配對遊戲",
            instructions: "點擊或拖放單詞到對應的意思或翻譯區域。",
            submit: "提交",
            undo: "撤銷",
            darkMode: "切換深色/淡色模式",
            wordBank: "查看單字庫",
            nextRound: "下一輪",
            restart: "再玩一次",
            correct: "答對",
            incorrect: "答錯",
            correctAnswersTitle: "正確答案："

          },

          en: {
            title: "Multi-Round Matching Game",
            instructions: "Click or drag the words to match their meanings or translations.",
            submit: "Submit",
            undo: "Undo",
            darkMode: "Toggle Dark/Light Mode",
            wordBank: "View Word Bank",
            nextRound: "Next Round",
            restart: "Play Again",
            correct: "correct",
            incorrect: "incorrect",
            correctAnswersTitle: "Correct Answers:"
          }
        };
        
        let isFirstRound = true;
        let words = JSON.parse(localStorage.getItem('words'));
        let settings = JSON.parse(localStorage.getItem('wordGameSettings')) || { wordsPerRound: 10 };
        let currentRoundWords = []; // 新增：当前轮次的单词
        let remainingWords = [...words]; // 修改：用于存储所有单词

        if (!words || words.length === 0) {
            words = [
                { word: "點擊按鈕「查看單字庫」設定單字。", translation: "Click the button 【View Word Bank】 to set the word." }
            ];
        }

        let selectedWord = null;
        const actionHistory = [];

        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        function createGame() {
            const wordContainer = document.querySelector('.words');
            const targetContainer = document.querySelector('.targets');
            const submitButton = document.getElementById('submit-btn');
            wordContainer.innerHTML = "";
            targetContainer.innerHTML = "";
            submitButton.disabled = true;

            if (isFirstRound) {
                document.getElementById('wordbank-btn').style.display = 'inline-block';
                // 第一轮：随机选择指定数量的单词
                currentRoundWords = shuffle([...words]).slice(0, Math.min(settings.wordsPerRound, words.length));
            } else {
                // 后续轮次：使用上一轮错误的单词
                currentRoundWords = [...remainingWords];
            }

            // 如果没有剩余单词，开始新的一局
            if (currentRoundWords.length === 0) {
                remainingWords = [...words];
                currentRoundWords = shuffle([...words]).slice(0, Math.min(settings.wordsPerRound, words.length));
            }

            const shuffledWords = shuffle([...currentRoundWords]);
            const shuffledTranslations = shuffle([...currentRoundWords]);

            shuffledWords.forEach(item => {
                const wordDiv = document.createElement('div');
                wordDiv.className = 'word';
                wordDiv.draggable = true;
                wordDiv.textContent = item.word;
                wordDiv.dataset.word = item.word;

                wordDiv.addEventListener('dragstart', dragStart);
                wordDiv.addEventListener('dragend', dragEnd);
                wordDiv.addEventListener('click', () => selectWord(wordDiv));

                wordContainer.appendChild(wordDiv);
            });

            shuffledTranslations.forEach(item => {
                const targetDiv = document.createElement('div');
                targetDiv.className = 'target';
                targetDiv.dataset.translation = item.translation;
                targetDiv.innerHTML = `
                    <div class="moved-word"></div>
                    <div class="original-translation">${item.translation}</div>
                    <button class="delete-btn" onclick="deleteWord(event, this)">×</button>
                `;
                targetDiv.addEventListener('dragover', allowDrop);
                targetDiv.addEventListener('drop', drop);
                targetDiv.addEventListener('click', () => matchWord(targetDiv));

                targetContainer.appendChild(targetDiv);
            });
        }
        function switchLanguage(lang) {
  document.getElementById('title').textContent = translations[lang].title; // 更新title元素的內容
  document.getElementById('instructions').textContent = translations[lang].instructions; // 更新instructions元素的內容
  document.getElementById('submit-btn').textContent = translations[lang].submit; // 更新submit-btn元素的內容
  document.getElementById('undo-btn').textContent = translations[lang].undo; // 更新undo-btn元素的內容
  document.getElementById('dark-mode-btn').textContent = translations[lang].darkMode; // 更新dark-mode-btn元素的內容
  document.getElementById('wordbank-btn').textContent = translations[lang].wordBank; // 更新wordbank-btn元素的內容
  document.getElementById('next-round-btn').textContent = translations[lang].nextRound; // 更新next-round-btn元素的內容
  document.getElementById('restart-btn').textContent = translations[lang].restart; // 更新restart-btn元素的內容
  currentLanguage = lang;
  // 隱藏當前語言的按鈕，顯示另一個語言的按鈕
  if (lang === 'zh') {
    document.querySelector('button[onclick="switchLanguage(\'zh\')"]').style.display = 'none';
    document.querySelector('button[onclick="switchLanguage(\'en\')"]').style.display = 'inline-block';
  } else {
    document.querySelector('button[onclick="switchLanguage(\'en\')"]').style.display = 'none';
    document.querySelector('button[onclick="switchLanguage(\'zh\')"]').style.display = 'inline-block';
  }
}


        function allowDrop(e) {
            e.preventDefault(); // 阻止預設行為
        }

        function dragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.word); // 設置拖動的數據
        }

        function dragEnd(e) {
            e.target.classList.remove('dragging'); // 移除dragging類別
        }

        function drop(e) {
            e.preventDefault(); // 阻止預設行為
            const word = e.dataTransfer.getData('text/plain'); // 獲取拖動的數據
            handleAction(e.target, word); // 處理動作
            checkIfAllFilled(); // 檢查是否所有目標元素都已填寫
        }

        function selectWord(wordElement) { // 選擇單字
            if (selectedWord) { // 如果已選擇單字
                selectedWord.classList.remove('selected'); // 移除selected類別
            }
            selectedWord = wordElement; // 設置選擇的單字元素
            selectedWord.classList.add('selected'); // 添加selected類別
        }

        function matchWord(targetElement) { // 匹配單字
            if (selectedWord) { // 如果已選擇單字
                handleAction(targetElement, selectedWord.dataset.word); // 處理動作
                selectedWord.classList.remove('selected'); // 移除selected類別
                selectedWord = null; // 設置選擇的單字元素為null
                checkIfAllFilled(); // 檢查是否所有目標元素都已填寫
            }
        }

        function handleAction(targetElement, word) { // 處理動作
            const movedWordDiv = targetElement.querySelector('.moved-word'); // 找到目標元素的moved-word元素
            const oldWord = targetElement.dataset.droppedWord || null; // 獲取目標元素的dataset.droppedWord屬性
            if (oldWord) { // 如果oldWord存在
                enableWord(oldWord); // 啟用oldWord
            }
            actionHistory.push({ target: targetElement, word: oldWord }); // 將動作添加到actionHistory中

            movedWordDiv.textContent = word; // 更新moved-word元素的內容
            disableWord(word); // 禁用word

            targetElement.dataset.droppedWord = word;
            toggleDeleteButton(targetElement);
        }

        function toggleDeleteButton(targetElement) {
            const deleteButton = targetElement.querySelector('.delete-btn');
            if (targetElement.dataset.droppedWord) { // 如果目標元素有dataset.droppedWord屬性
                targetElement.classList.add('has-word'); // 添加has-word類別 
            } else {
                targetElement.classList.remove('has-word'); // 移除has-word類別
            }
        }

        function undoLastAction() {
            if (actionHistory.length === 0) return; // 如果沒有任何動作，則不執行
            const { target, word } = actionHistory.pop(); // 從actionHistory中移除最後一個動作
            const movedWordDiv = target.querySelector('.moved-word'); // 找到目標元素的moved-word元素
            const currentWord = target.dataset.droppedWord; // 獲取當前單字
            if (currentWord) { // 如果當前單字存在
                enableWord(currentWord);
            }
            if (word) { // 如果word存在
                disableWord(word); // 禁用word
                target.dataset.droppedWord = word; // 設置目標元素的dataset.droppedWord屬性為word
                movedWordDiv.textContent = word; // 更新moved-word元素的內容
            } else {
                delete target.dataset.droppedWord; // 刪除目標元素的dataset.droppedWord屬性
                movedWordDiv.textContent = ""; // 清空moved-word元素的內容
            }
            toggleDeleteButton(target); // 更新目標元素的has-word狀態
            checkIfAllFilled(); // 檢查是否所有目標元素都已填寫
        }

        function enableWord(word) { // 啟用單字
            const wordDiv = document.querySelector(`.word[data-word="${word}"]`); // 找到對應的單字元素
            if (wordDiv) { // 如果單字元素存在
                wordDiv.classList.remove('used'); // 移除used類別
                wordDiv.addEventListener('click', () => selectWord(wordDiv)); // 添加點擊事件
            }
        }

        function disableWord(word) { // 禁用單字
            const wordDiv = document.querySelector(`.word[data-word="${word}"]`); // 找到對應的單字元素
            if (wordDiv) { // 如果單字元素存在
                wordDiv.classList.add('used'); // 添加used類別
                wordDiv.removeEventListener('click', selectWord); // 移除點擊事件
            }
        }

        function deleteWord(event, button) { // 刪除單字
            event.stopPropagation(); // 停止事件傳遞
            const target = button.closest('.target'); // 找到最近的目標元素
            const currentWord = target.dataset.droppedWord; // 獲取當前單字
            if (currentWord) { // 如果當前單字存在
                enableWord(currentWord); // 啟用單字
            }
            delete target.dataset.droppedWord; // 刪除目標元素的dataset.droppedWord屬性
            target.querySelector('.moved-word').textContent = ""; // 清空目標元素的moved-word內容
            toggleDeleteButton(target); // 更新目標元素的has-word狀態
            checkIfAllFilled(); // 檢查是否所有目標元素都已填寫
        }

        function resetGame() { // 重置遊戲
            document.querySelectorAll('.target').forEach(target => { // 對所有目標元素進行操作
                target.querySelector('.moved-word').textContent = ""; // 清空目標元素的moved-word內容
                delete target.dataset.droppedWord; // 刪除目標元素的dataset.droppedWord屬性
                toggleDeleteButton(target); // 更新目標元素的has-word狀態
            });
            document.querySelectorAll('.word').forEach(word => {
                word.classList.remove('used'); // 移除used類別
                word.addEventListener('click', () => selectWord(word)); // 添加點擊事件
            });
            document.getElementById('submit-btn').disabled = true; // 禁用提交按鈕
        }

        function checkIfAllFilled() {
            const targetElements = document.querySelectorAll('.target'); // 找到所有目標元素
            const allFilled = Array.from(targetElements).every(target => target.dataset.droppedWord); // 檢查所有目標元素是否都有dataset.droppedWord屬性
            document.getElementById('submit-btn').disabled = false; // 啟用提交按鈕
        }

        function checkAnswers() {
            const targetElements = document.querySelectorAll('.target');
            const unfilledTargets = Array.from(targetElements).filter(target => !target.dataset.droppedWord);
            
            if (unfilledTargets.length > 0) {
                const confirmMessage = currentLanguage === 'zh' 
                    ? `還有 ${unfilledTargets.length} 個空格未填寫，確定要提交嗎？`
                    : `There are ${unfilledTargets.length} empty spaces. Are you sure you want to submit?`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
            }

            const correctAnswers = [];
            const wrongAnswers = [];
            const unusedWords = [];

            const usedWords = new Set();
            targetElements.forEach(target => {
                const droppedWord = target.dataset.droppedWord;
                if (droppedWord) {
                    usedWords.add(droppedWord);
                    if (words.find(w => w.word === droppedWord)?.translation === target.dataset.translation) {
                        target.classList.add('correct');
                        correctAnswers.push(droppedWord);
                    } else {
                        target.classList.add('incorrect');
                        wrongAnswers.push(droppedWord);
                    }
                } else {
                    target.classList.add('incorrect');
                }
            });

            document.querySelectorAll('.word').forEach(wordDiv => {
                const word = wordDiv.dataset.word;
                if (!usedWords.has(word)) {
                    const wordObj = words.find(w => w.word === word);
                    if (wordObj) {
                        unusedWords.push(wordObj);
                    }
                }
            });

            // 更新剩余单词列表，只保留错误的单词
            remainingWords = currentRoundWords.filter(word => 
                wrongAnswers.includes(word.word) || unusedWords.some(w => w.word === word.word)
            );

            const resultDiv = document.getElementById('result');
            const answersDiv = document.getElementById('answers');
            const nextRoundBtn = document.getElementById('next-round-btn');
            const restartBtn = document.getElementById('restart-btn');

            resultDiv.style.display = 'block';
            answersDiv.style.display = 'block';
            
            if (isFirstRound) {
                document.getElementById('wordbank-btn').style.display = 'none';
                isFirstRound = false;
            }

            const t = translations[currentLanguage];
            resultDiv.innerHTML = `<h2>${correctAnswers.length} ${t.correct}, ${wrongAnswers.length + unfilledTargets.length} ${t.incorrect}.</h2>`;
            
            let answersHTML = '';
            if (wrongAnswers.length > 0) {
                answersHTML += `<p>${t.correctAnswersTitle}</p><ul>`;
                wrongAnswers.forEach(word => {
                    const correctTranslation = words.find(w => w.word === word)?.translation;
                    answersHTML += `<li>${word}: ${correctTranslation}</li>`;
                });
                answersHTML += '</ul>';
            }
            if (unusedWords.length > 0) {
                answersHTML += `<p>${currentLanguage === 'zh' ? '未使用的單字：' : 'Unused words:'}</p><ul>`;
                unusedWords.forEach(wordObj => {
                    answersHTML += `<li>${wordObj.word}: ${wordObj.translation}</li>`;
                });
                answersHTML += '</ul>';
            }
            answersDiv.innerHTML = answersHTML;

            // 根据剩余单词数量决定显示哪个按钮
            if (remainingWords.length > 0) {
                nextRoundBtn.style.display = 'block';
                restartBtn.style.display = 'none';
            } else {
                nextRoundBtn.style.display = 'none';
                restartBtn.style.display = 'block';
            }
        }
    function nextRound() { // 進行下一輪
        document.getElementById('result').style.display = 'none'; // 隱藏結果
            document.getElementById('answers').style.display = 'none'; // 隱藏答案
        document.getElementById('next-round-btn').style.display = 'none'; // 隱藏下一輪按鈕
        document.getElementById('wordbank-btn').style.display = 'inline-block'; // 顯示單字庫按鈕
        createGame(); // 重新開始遊戲
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        createGame();
        const userLang = navigator.language || navigator.userLanguage;
switchLanguage(userLang.startsWith('zh') ? 'zh' : 'en');

        function restartGame() {
    remainingWords = [...words];
    isFirstRound = true;
    document.getElementById('result').style.display = 'none';
    document.getElementById('answers').style.display = 'none';
    document.getElementById('restart-btn').style.display = 'none';
    document.getElementById('wordbank-btn').style.display = 'inline-block';
    createGame();
}
function openWordBank() {
    window.open(`單字庫.html?lang=${currentLanguage}`, '_blank');
}

    </script>
</body>
</html>