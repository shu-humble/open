<!DOCTYPE html> 
<html lang="UTF-8">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>單字配對</title>
    <link rel="icon" href="https://www.svgrepo.com/show/335618/quiz-submissions.svg">
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            padding: 0;
            background-color: #f4f4f9;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark-mode {
            background-color: #333;
            color: #f4f4f9;
        }
        .game-container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark-mode .game-container {
            background: #444;
            color: #fff;
        }
        .instructions {
            margin-bottom: 20px;
        }
        .words, .targets {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .word, .target {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #e0e0e0;
            cursor: pointer;
            user-select: none;
            text-align: center;
            width: 120px;
            transition: background-color 0.3s, color 0.3s;
            position: relative;
        }
        .word.used {
            background: #d3d3d3;
            color: #999;
            cursor: not-allowed;
        }
        body.dark-mode .word.used {
            background: #555;
            color: #777;
        }
        body.dark-mode .word, body.dark-mode .target {
            background: #555;
            border-color: #777;
            color: #fff;
        }
        .target {
            background: #f9f9f9;
            border: 2px dashed #ccc;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .target .moved-word {
            font-weight: bold;
        }
        .target .original-translation {
            font-size: 0.9em;
            color: gray;
        }
        .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: red;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            display: none;
            cursor: pointer;
        }
        .target.has-word:hover .delete-btn {
            display: block;
        }
        body.dark-mode .target .original-translation {
            color: lightgray;
        }
        .target.correct {
            border-color: green;
        }
        .target.incorrect {
            border-color: red;
        }
        .selected {
            background: #add8e6;
        }
        body.dark-mode .selected {
            background: #87ceeb;
            color: #000;
        }
        .buttons {
            margin-top: 10px;
        }
        .button {
            display: inline-block;
            margin: 5px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        .button:hover {
            background-color: #0056b3;
        }
        body.dark-mode .button {
            background-color: #555;
            color: #fff;
        }
        body.dark-mode .button:hover {
            background-color: #777;
        }
        .result, .answers {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }
        .result {
            background: #ffe0e0;
            border: 1px solid #d8b2b2;
        }
        .answers {
            background: #e0ffe0;
            border: 1px solid #b2d8b2;
        }
        body.dark-mode .result {
            background: #444;
            border-color: #777;
            color: #fff;
        }
        body.dark-mode .answers {
            background: #555;
            border-color: #777;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 id="title"></h1> <p class="instructions" id="instructions"></p>
        <div class="words">
            </div>
        <div class="targets">
            </div>
        <div class="buttons">
            <button class="button" onclick="toggleDarkMode()" id="dark-mode-btn"></button>
            <button class="button" onclick="undoLastAction()" id="undo-btn"></button>
            <button class="button" id="submit-btn" onclick="checkAnswers()" disabled></button>
            <button id="wordbank-btn" class="button" onclick="openWordBank()"></button>
            <button class="button" onclick="switchLanguage('zh')">中文</button>
            <button class="button" onclick="switchLanguage('en')">English</button>
            <button id="next-round-btn" class="button" onclick="nextRound()" style="display:none;"></button>
            <button id="restart-btn" class="button" onclick="restartGame()" style="display:none;"></button>
            
</div>
        </div>
        <div id="result" class="result" style="display:none;"></div>
        <div id="answers" class="answers" style="display:none;"></div>
    </div>

    <script>
        let currentLanguage = 'zh'; // 預設語言

        const translations = {
          zh: {
            title: "單字配對",
            instructions: "點擊或拖放單詞到對應的意思或翻譯區域。",
            submit: "提交",
            undo: "撤銷",
            darkMode: "切換深色/淡色模式",
            wordBank: "查看單字庫",
            nextRound: "下一輪",
            restart: "再玩一次",
            correct: "答對",
            incorrect: "答錯",
            correctAnswersTitle: "正確答案：",
            wordBankInitialPlaceholder: "沒有單字可供測驗。", // 新增此行
            wordBankInitialPlaceholderTranslation: "請點擊「查看單字庫」新增單字。" // 新增此行

          },

          en: {
            title: "Word Game",
            instructions: "Click or drag the words to match their meanings or translations.",
            submit: "Submit",
            undo: "Undo",
            darkMode: "Toggle Dark/Light Mode",
            wordBank: "View Word Bank",
            nextRound: "Next Round",
            restart: "Play Again",
            correct: "correct",
            incorrect: "incorrect",
            correctAnswersTitle: "Correct Answers:",
            wordBankInitialPlaceholder: "No words to test.", // 新增此行
            wordBankInitialPlaceholderTranslation: "Click \"View Word Bank\" to add words." // 新增此行
          }
        };
        
    let isFirstRound = true;
    // words 陣列現在只在 createGame 和 checkAnswers 內部需要時重新載入

    // 擴展單字數據結構，確保每個單字都有 wrongCount, correctCount 和 hasBeenTested
    function initializeOrUpdateWords(wordsArray) {
        return wordsArray.map(wordItem => {
            return {
                word: wordItem.word,
                translation: wordItem.translation,
                wrongCount: wordItem.wrongCount !== undefined ? wordItem.wrongCount : 0,
                correctCount: wordItem.correctCount !== undefined ? wordItem.correctCount : 0, 
                hasBeenTested: wordItem.hasBeenTested !== undefined ? wordItem.hasBeenTested : false 
            };
        });
    }


    let settings = JSON.parse(localStorage.getItem('wordGameSettings')) || { 
        wordsPerRound: 10,
        enableWeightSystem: true 
    };

    // 追蹤本輪遊戲中已經出題的單字
    let wordsTestedInSession = new Set();
    // 總單字數，用於判斷是否所有單字都考過一次
    let totalUniqueWords = 0; // 將在 createGame 中設定

    let currentRoundWords = [];
    let selectedWord = null;
    const actionHistory = [];

    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }

    function createGame() {
        // **BUG FIX 1: 每次創建遊戲時，從 localStorage 重新載入最新數據**
        let words = JSON.parse(localStorage.getItem('words')) || [];
        words = initializeOrUpdateWords(words); // 確保每個單字有必要的屬性

        const wordContainer = document.querySelector('.words');
        const targetContainer = document.querySelector('.targets');
        const submitButton = document.getElementById('submit-btn');
        wordContainer.innerHTML = "";
        targetContainer.innerHTML = "";
        submitButton.disabled = true;

        // 更新 totalUniqueWords
        totalUniqueWords = new Set(words.map(w => w.word)).size;

        // 如果 words 為空，顯示提示信息
        if (words.length === 0 || (words.length === 1 && words[0].word === translations[currentLanguage].wordBankInitialPlaceholder)) {
            wordContainer.innerHTML = `<p>${translations[currentLanguage].wordBankInitialPlaceholderTranslation}</p>`;
            document.getElementById('submit-btn').style.display = 'none'; // 隱藏提交按鈕
            return; 
        } else {
             document.getElementById('submit-btn').style.display = 'inline-block'; // 顯示提交按鈕
        }

        const numWordsForRound = Math.min(settings.wordsPerRound, words.length); 
        let wordsToChoose = [...words]; 

        // 重置 wordsTestedInSession，因為每次創建遊戲都可能讀取到新的 words 數據
        wordsTestedInSession = new Set(words.filter(w => w.hasBeenTested).map(w => w.word));


        // 如果未啟用權重系統，則只隨機選擇單字
        if (!settings.enableWeightSystem) {
            currentRoundWords = shuffle(wordsToChoose).slice(0, numWordsForRound);
        } else {
            // **權重出題系統啟用時的邏輯**
            // 判斷是否所有單字都已考過一次 (基於 wordsTestedInSession)
            const allWordsTestedOnce = wordsTestedInSession.size >= totalUniqueWords;

            let newWords = wordsToChoose.filter(w => !w.hasBeenTested); 
            let testedWords = wordsToChoose.filter(w => w.hasBeenTested); 

            if (!allWordsTestedOnce && newWords.length > 0) {
                // 策略：優先考新的 (2/3)，權重 (1/3)
                let numNew = Math.min(Math.ceil(numWordsForRound * (2 / 3)), newWords.length);
                let selectedNewWords = shuffle(newWords).slice(0, numNew);

                let numWeighted = numWordsForRound - selectedNewWords.length;
                let weightedWords = testedWords.sort((a, b) => b.wrongCount - a.wrongCount); 
                let selectedWeightedWords = shuffle(weightedWords).slice(0, numWeighted); 

                currentRoundWords = shuffle([...selectedNewWords, ...selectedWeightedWords]);

            } else {
                // 策略：所有考題都考過後，權重 (3/4)，隨機抽出 (1/4)
                let numWeighted = Math.min(Math.ceil(numWordsForRound * (3 / 4)), testedWords.length);
                let numRandom = numWordsForRound - numWeighted;

                let weightedWords = testedWords.sort((a, b) => b.wrongCount - a.wrongCount); 
                let selectedWeightedWords = shuffle(weightedWords).slice(0, numWeighted); 

                let remainingRandomWords = testedWords.filter(word => !selectedWeightedWords.includes(word)); 
                let selectedRandomWords = shuffle(remainingRandomWords).slice(0, numRandom);

                currentRoundWords = shuffle([...selectedWeightedWords, ...selectedRandomWords]);
            }
        }
        
        // 確保至少有 enough words to fill the round
        if (currentRoundWords.length < numWordsForRound && wordsToChoose.length > currentRoundWords.length) {
            const alreadySelectedWords = new Set(currentRoundWords.map(w => w.word));
            const availableWords = wordsToChoose.filter(w => !alreadySelectedWords.has(w.word));
            const wordsToFill = shuffle(availableWords).slice(0, numWordsForRound - currentRoundWords.length);
            currentRoundWords = shuffle([...currentRoundWords, ...wordsToFill]);
        }

        // 如果由於篩選導致 currentRoundWords 仍然是空的，但有單字，則隨機選擇一些
        if (currentRoundWords.length === 0 && words.length > 0) {
             currentRoundWords = shuffle([...words]).slice(0, numWordsForRound);
        }

        // **標記本輪被選中的單字為已考過**
        currentRoundWords.forEach(wordObj => {
            const originalWordIndex = words.findIndex(w => w.word === wordObj.word);
            if (originalWordIndex !== -1) {
                words[originalWordIndex].hasBeenTested = true;
                wordsTestedInSession.add(wordObj.word); 
            }
        });
        localStorage.setItem('words', JSON.stringify(words)); // 保存標記後的單字

        const shuffledWords = shuffle([...currentRoundWords]);
        const shuffledTranslations = shuffle([...currentRoundWords]);


            shuffledWords.forEach(item => {
                const wordDiv = document.createElement('div');
                wordDiv.className = 'word';
                wordDiv.draggable = true;
                wordDiv.textContent = item.word;
                wordDiv.dataset.word = item.word;

                wordDiv.addEventListener('dragstart', dragStart);
                wordDiv.addEventListener('dragend', dragEnd);
                wordDiv.addEventListener('click', () => selectWord(wordDiv));

                wordContainer.appendChild(wordDiv);
            });

            shuffledTranslations.forEach(item => {
                const targetDiv = document.createElement('div');
                targetDiv.className = 'target';
                targetDiv.dataset.translation = item.translation;
                targetDiv.innerHTML = `
                    <div class="moved-word"></div>
                    <div class="original-translation">${item.translation}</div>
                    <button class="delete-btn" onclick="deleteWord(event, this)">×</button>
                `;
                targetDiv.addEventListener('dragover', allowDrop);
                targetDiv.addEventListener('drop', drop);
                targetDiv.addEventListener('click', () => matchWord(targetDiv));

                targetContainer.appendChild(targetDiv);
            });
        }
        function switchLanguage(lang) {
            currentLanguage = lang;
            const t = translations[currentLanguage];
            document.getElementById('title').textContent = t.title; 
            document.getElementById('instructions').textContent = t.instructions; 
            document.getElementById('submit-btn').textContent = t.submit; 
            document.getElementById('undo-btn').textContent = t.undo; 
            document.getElementById('dark-mode-btn').textContent = t.darkMode; 
            document.getElementById('wordbank-btn').textContent = t.wordBank; 
            document.getElementById('next-round-btn').textContent = t.nextRound; 
            document.getElementById('restart-btn').textContent = t.restart; 
            
            // 隱藏當前語言的按鈕，顯示另一個語言的按鈕
            document.querySelector('button[onclick="switchLanguage(\'zh\')"]').style.display = (lang === 'zh' ? 'none' : 'inline-block');
            document.querySelector('button[onclick="switchLanguage(\'en\')"]').style.display = (lang === 'en' ? 'none' : 'inline-block');

            // 重新創建遊戲來更新佔位符單字的語言
            // 這段邏輯現在由 createGame 處理，因為它會重新讀取 words
            // 但如果當前 words 是空的，還是需要確保 placeholder 翻譯正確
            let wordsFromStorage = JSON.parse(localStorage.getItem('words')) || [];
            if (wordsFromStorage.length === 0 || (wordsFromStorage.length === 1 && wordsFromStorage[0].word === translations['zh'].wordBankInitialPlaceholder || wordsFromStorage[0].word === translations['en'].wordBankInitialPlaceholder)) {
                wordsFromStorage = [{ 
                    word: t.wordBankInitialPlaceholder, 
                    translation: t.wordBankInitialPlaceholderTranslation, 
                    wrongCount: 0, 
                    correctCount: 0, 
                    hasBeenTested: false 
                }];
                localStorage.setItem('words', JSON.stringify(wordsFromStorage));
            }
            createGame(); // 重新渲染以更新佔位符或遊戲內容
        }


        function allowDrop(e) {
            e.preventDefault(); 
        }

        function dragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.word); 
        }

        function dragEnd(e) {
            e.target.classList.remove('dragging'); 
        }

        function drop(e) {
            e.preventDefault(); 
            const word = e.dataTransfer.getData('text/plain'); 
            handleAction(e.target, word); 
            checkIfAllFilled(); 
        }

        function selectWord(wordElement) { 
            if (selectedWord) { 
                selectedWord.classList.remove('selected'); 
            }
            selectedWord = wordElement; 
            selectedWord.classList.add('selected'); 
        }

        function matchWord(targetElement) { 
            if (selectedWord) { 
                handleAction(targetElement, selectedWord.dataset.word); 
                selectedWord.classList.remove('selected'); 
                selectedWord = null; 
                checkIfAllFilled(); 
            }
        }

        function handleAction(targetElement, word) { 
            const movedWordDiv = targetElement.querySelector('.moved-word'); 
            const oldWord = targetElement.dataset.droppedWord || null; 
            if (oldWord) { 
                enableWord(oldWord); 
            }
            actionHistory.push({ target: targetElement, word: oldWord }); 

            movedWordDiv.textContent = word; 
            disableWord(word); 

            targetElement.dataset.droppedWord = word;
            toggleDeleteButton(targetElement);
        }

        function toggleDeleteButton(targetElement) {
            const deleteButton = targetElement.querySelector('.delete-btn');
            if (targetElement.dataset.droppedWord) { 
                targetElement.classList.add('has-word'); 
            } else {
                targetElement.classList.remove('has-word'); 
            }
        }

        function undoLastAction() {
            if (actionHistory.length === 0) return; 
            const { target, word } = actionHistory.pop(); 
            const movedWordDiv = target.querySelector('.moved-word'); 
            const currentWord = target.dataset.droppedWord; 
            if (currentWord) { 
                enableWord(currentWord);
            }
            if (word) { 
                disableWord(word); 
                target.dataset.droppedWord = word; 
                movedWordDiv.textContent = word; 
            } else {
                delete target.dataset.droppedWord; 
                movedWordDiv.textContent = ""; 
            }
            toggleDeleteButton(target); 
            checkIfAllFilled(); 
        }

        function enableWord(word) { 
            const wordDiv = document.querySelector(`.word[data-word="${word}"]`); 
            if (wordDiv) { 
                wordDiv.classList.remove('used'); 
                wordDiv.addEventListener('click', () => selectWord(wordDiv)); 
            }
        }

        function disableWord(word) { 
            const wordDiv = document.querySelector(`.word[data-word="${word}"]`); 
            if (wordDiv) { 
                wordDiv.classList.add('used'); 
                wordDiv.removeEventListener('click', selectWord); 
            }
        }

        function deleteWord(event, button) { 
            event.stopPropagation(); 
            const target = button.closest('.target'); 
            const currentWord = target.dataset.droppedWord; 
            if (currentWord) { 
                enableWord(currentWord); 
            }
            delete target.dataset.droppedWord; 
            target.querySelector('.moved-word').textContent = ""; 
            toggleDeleteButton(target); 
            checkIfAllFilled(); 
        }

        function resetGame() { 
            document.querySelectorAll('.target').forEach(target => { 
                target.querySelector('.moved-word').textContent = ""; 
                delete target.dataset.droppedWord; 
                target.classList.remove('correct', 'incorrect'); // 清除對錯顏色
                toggleDeleteButton(target); 
            });
            document.querySelectorAll('.word').forEach(word => {
                word.classList.remove('used'); 
                word.addEventListener('click', () => selectWord(word)); 
            });
            document.getElementById('submit-btn').disabled = true; 
        }

        function checkIfAllFilled() {
            const targetElements = document.querySelectorAll('.target'); 
            const allFilled = Array.from(targetElements).every(target => target.dataset.droppedWord); 
            // 只有當所有目標都填寫了，提交按鈕才啟用
            document.getElementById('submit-btn').disabled = !allFilled; 
        }

        function checkAnswers() {
            // **BUG FIX 2: 每次提交答案時，從 localStorage 重新載入最新數據**
            let words = JSON.parse(localStorage.getItem('words')) || [];
            words = initializeOrUpdateWords(words); // 確保每個單字有必要的屬性

            const targetElements = document.querySelectorAll('.target');
            const unfilledTargets = Array.from(targetElements).filter(target => !target.dataset.droppedWord);
            
            if (unfilledTargets.length > 0) {
                const confirmMessage = currentLanguage === 'zh' 
                    ? `還有 ${unfilledTargets.length} 個空格未填寫，確定要提交嗎？`
                    : `There are ${unfilledTargets.length} empty spaces. Are you sure you want to submit?`;
                
                if (!confirm(confirmMessage)) {
                    return;
                }
            }

            const correctAnswers = [];
            const wrongAnswers = [];
            const unusedWords = [];

            const usedWords = new Set();
            targetElements.forEach(target => {
                const droppedWord = target.dataset.droppedWord;
                const originalTranslation = target.dataset.translation; // 獲取目標的原始翻譯
                target.classList.remove('correct', 'incorrect'); // 清除之前的狀態

                if (droppedWord) {
                    usedWords.add(droppedWord);
                    const originalWordIndex = words.findIndex(w => w.word === droppedWord); 

                    if (originalWordIndex !== -1) { 
                        const originalWordObj = words[originalWordIndex]; 
                        if (originalWordObj.translation === originalTranslation) { // 與目標的原始翻譯比較
                            target.classList.add('correct');
                            correctAnswers.push(droppedWord);
                            originalWordObj.correctCount++; // 答對次數加1
                            originalWordObj.wrongCount = Math.max(0, originalWordObj.wrongCount - 1); // 答錯次數減1（最低為0）
                        } else {
                            target.classList.add('incorrect');
                            wrongAnswers.push(droppedWord);
                            originalWordObj.wrongCount++; // 答錯次數加1
                        }
                    }
                } else {
                    target.classList.add('incorrect');
                }
            });

            document.querySelectorAll('.word').forEach(wordDiv => {
                const word = wordDiv.dataset.word;
                if (!usedWords.has(word)) {
                    const originalWordIndex = words.findIndex(w => w.word === word);
                    if (originalWordIndex !== -1) {
                        const wordObj = words[originalWordIndex];
                        unusedWords.push(wordObj);
                        // 未使用的單字：也視為錯誤，增加權重
                        wordObj.wrongCount++;
                    }
                }
            });

            // **重要：將更新後的 words 數據存回 localStorage**
            localStorage.setItem('words', JSON.stringify(words));

            // 更新剩余单词列表，只保留错误的单词
            remainingWords = currentRoundWords.filter(word => 
                wrongAnswers.includes(word.word) || unusedWords.some(w => w.word === word.word)
            );

            const resultDiv = document.getElementById('result');
            const answersDiv = document.getElementById('answers');
            const nextRoundBtn = document.getElementById('next-round-btn');
            const restartBtn = document.getElementById('restart-btn');

            resultDiv.style.display = 'block';
            answersDiv.style.display = 'block';
            document.getElementById('submit-btn').disabled = true; // 提交後禁用按鈕
            
            if (isFirstRound) {
                document.getElementById('wordbank-btn').style.display = 'none';
                isFirstRound = false;
            }

            const t = translations[currentLanguage];
            resultDiv.innerHTML = `<h2>${correctAnswers.length} ${t.correct}, ${wrongAnswers.length + unfilledTargets.length} ${t.incorrect}.</h2>`;
            
            let answersHTML = '';
            if (wrongAnswers.length > 0 || unusedWords.length > 0) { // 只有當有錯誤或未使用的單字時才顯示正確答案標題
                answersHTML += `<p>${t.correctAnswersTitle}</p><ul>`; 
                wrongAnswers.forEach(word => {
                    const correctTranslation = words.find(w => w.word === word)?.translation;
                    answersHTML += `<li>${word}: ${correctTranslation}</li>`;
                });
                unusedWords.forEach(wordObj => { // 未使用的單字
                    answersHTML += `<li>${wordObj.word}: ${wordObj.translation} (${currentLanguage === 'zh' ? '未選擇' : 'Unselected'})</li>`;
                });
                answersHTML += '</ul>';
            } else {
                answersHTML += `<p>${currentLanguage === 'zh' ? '太棒了！所有單字都答對了！' : 'Excellent! All words matched correctly!'}</p>`;
            }
            answersDiv.innerHTML = answersHTML;

            // 重新計算 remainingWords，只包含在這一輪中答錯或未使用的單字
            remainingWords = currentRoundWords.filter(wordObj => 
                wrongAnswers.includes(wordObj.word) || unusedWords.some(w => w.word === wordObj.word)
            );

            if (remainingWords.length > 0) {
                nextRoundBtn.style.display = 'block';
                restartBtn.style.display = 'none';
            } else {
                nextRoundBtn.style.display = 'none';
                restartBtn.style.display = 'block';
            }
        }
    function nextRound() { 
        document.getElementById('result').style.display = 'none'; 
        document.getElementById('answers').style.display = 'none'; 
        document.getElementById('next-round-btn').style.display = 'none'; 
        document.getElementById('wordbank-btn').style.display = 'inline-block'; 
        resetGame(); // 清空上次的答案和顏色
        createGame(); 
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        // 頁面載入時根據瀏覽器語言或預設語言設定介面
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const langParam = urlParams.get('lang');
            if (langParam && (langParam === 'zh' || langParam === 'en')) {
                currentLanguage = langParam;
            } else {
                const userLang = navigator.language || navigator.userLanguage;
                currentLanguage = userLang.startsWith('zh') ? 'zh' : 'en';
            }
            
            // 初始載入時，先設定好語言，然後讓 createGame 去處理 words
            switchLanguage(currentLanguage); // 第一次載入時設定所有文字
            createGame(); // 載入遊戲
        });


function restartGame() {
        // **BUG FIX 3: 重新載入 words 陣列以確保是最新的**
        let words = JSON.parse(localStorage.getItem('words')) || [];
        words = initializeOrUpdateWords(words);

        // 重置所有單字的 hasBeenTested 狀態為 false
        words.forEach(word => word.hasBeenTested = false);
        localStorage.setItem('words', JSON.stringify(words)); 

        wordsTestedInSession.clear(); 

        isFirstRound = true;
        document.getElementById('result').style.display = 'none';
        document.getElementById('answers').style.display = 'none';
        document.getElementById('restart-btn').style.display = 'none';
        document.getElementById('wordbank-btn').style.display = 'inline-block';
        resetGame(); // 清空上次的答案和顏色
        createGame();
    }
function openWordBank() {
    window.open(`單字庫.html?lang=${currentLanguage}`, '_blank');
}

    </script>
</body>
</html>