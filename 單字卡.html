<!DOCTYPE html>
<html lang="UTF-8">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="icon" href="https://www.svgrepo.com/show/335618/quiz-submissions.svg">
    <style>
        :root {
            --bg: #edf2ff;
            --panel: #ffffff;
            --text: #0f172a;
            --muted: #475569;
            --border: #d7deed;
            --accent: #2563eb;
            --accent-strong: #1d4ed8;
            --good: #16a34a;
            --bad: #ef4444;
        }
        body.dark-mode {
            --bg: #0a0f1f;
            --panel: #0c1326;
            --text: #f9fafb;
            --muted: #d7deed;
            --border: #2d3e5c;
            --accent: #8ac7ff;
            --accent-strong: #58a6ff;
            --good: #3ee07a;
            --bad: #ff8b8b;
        }
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 26px 18px 36px;
            background-color: var(--bg);
            background-image:
              radial-gradient(circle at 20% 20%, rgba(37,99,235,0.15), transparent 30%),
              radial-gradient(circle at 80% 0%, rgba(16,185,129,0.12), transparent 32%),
              linear-gradient(135deg, rgba(37,99,235,0.08), rgba(255,255,255,0)),
              repeating-linear-gradient(45deg, rgba(15,23,42,0.04), rgba(15,23,42,0.04) 4px, transparent 4px, transparent 12px);
            color: var(--text);
            transition: background-color 0.3s, color 0.3s, background-image 0.3s;
            min-height: 100vh;
        }
        .game-container {
            max-width: 860px;
            margin: auto;
            padding: 22px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 12px 34px rgba(17,24,39,0.16);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .instructions {
            margin-bottom: 16px;
            color: var(--muted);
        }
        .words, .targets {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin-bottom: 18px;
            gap: 8px;
        }
        .word, .target {
            padding: 11px;
            margin: 4px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: linear-gradient(150deg, rgba(37,99,235,0.18), rgba(255,255,255,0.9));
            cursor: pointer;
            user-select: none;
            text-align: center;
            width: 120px;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s, box-shadow 0.2s;
            position: relative;
            box-shadow: 0 10px 24px rgba(37,99,235,0.25);
        }
        .word:active { cursor: grabbing; }
        .word.used {
            background: #e5e7eb;
            color: #7d8799;
            cursor: not-allowed;
            box-shadow: none;
        }
        .word.paired { color: #6f7a91; box-shadow: none; }
        .target.has-word { box-shadow: none; }
        body.dark-mode .word.used { background: #1c2536; color: #a0abc4; }
        body.dark-mode .word.paired {
            background: linear-gradient(150deg, rgba(138,199,255,0.4), rgba(10,15,31,0.9));
            color: rgba(255,255,255,0.75);
            box-shadow: none;
        }
        body.dark-mode .target.has-word { box-shadow: none; }
        body.dark-mode .word, body.dark-mode .target {
            background: linear-gradient(150deg, rgba(138,199,255,0.35), rgba(10,15,31,0.96));
            border-color: var(--border);
            color: var(--text);
        }
        .target {
            background: linear-gradient(140deg, rgba(37,99,235,0.12), rgba(255,255,255,0.92));
            border: 1.5px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .target .moved-word { font-weight: bold; }
        .target .original-translation { font-size: 0.9em; color: var(--muted); }
        .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--bad);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            display: none;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
        }
        .target.has-word:hover .delete-btn { display: block; }
        .target.correct { border-color: var(--good); }
        .target.incorrect { border-color: var(--bad); }
        .selected {
            background: linear-gradient(145deg, rgba(37,99,235,0.32), rgba(37,99,235,0.16));
            border-color: var(--accent);
            box-shadow: 0 12px 28px rgba(37,99,235,0.32);
        }
        body.dark-mode .selected {
            background: linear-gradient(145deg, rgba(124,195,255,0.46), rgba(78,166,255,0.22));
            color: #ffffff;
            text-shadow: 0 0 8px rgba(12, 19, 38, 0.7);
            box-shadow: 0 14px 32px rgba(78,166,255,0.35);
        }
        .buttons { margin-top: 10px; }
        .button {
            display: inline-block;
            margin: 5px;
            padding: 10px 15px;
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 12px 26px rgba(37,99,235,0.28);
            transition: background-color 0.2s, transform 0.15s, box-shadow 0.2s;
        }
        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 30px rgba(37,99,235,0.36);
        }
        body.dark-mode .button {
            background: linear-gradient(135deg, #7cb2ff, #4f8afc);
            color: #0b1021;
        }
        .result, .answers {
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 18px rgba(255, 255, 255, 0.08);
        }
        .result { background: rgba(239,68,68,0.14); }
        .answers { background: rgba(22,163,74,0.14); }
        body.dark-mode .result {
            background: rgba(255, 139, 139, 0.4);
            border-color: rgba(255, 139, 139, 0.75);
        }
        body.dark-mode .answers {
            background: rgba(62,224,122,0.4);
            border-color: rgba(62,224,122,0.75);
            color: #ffffff;
        }
        .answers h4 {
            margin-top: 12px;
            margin-bottom: 6px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 4px;
        }
        .help-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background-color: var(--accent);
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: background-color 0.2s;
        }
        .help-button:hover { background-color: var(--accent-strong); }
        .rules-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.45);
            z-index: 1001;
        }
        .rules-content {
            position: relative;
            background-color: var(--panel);
            margin: 20px auto 8px auto;
            padding: 20px;
            width: 80%;
            max-width: 820px;
            height: calc(100vh - 32px);
            max-height: calc(100vh - 32px);
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 10px 26px rgba(0,0,0,0.2);
        }
        body.dark-mode .rules-content {
            background-color: var(--panel);
            color: var(--text);
        }
    </style>
</head>
<body>
    <button class="help-button" onclick="toggleRules()">?</button>
    <div class="rules-modal" id="rulesModal" onclick="closeRules(event)">
        <div class="rules-content">
            <iframe src="規則.html" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
    </div>
    <div class="game-container">
        <h1 id="title"></h1>
        <p class="instructions" id="instructions"></p>
        <div class="words">
        </div>
        <div class="targets">
        </div>
        <div class="buttons">
            <button class="button" onclick="toggleDarkMode()" id="dark-mode-btn"></button>
            <button class="button" onclick="undoLastAction()" id="undo-btn"></button>
            <button class="button" id="submit-btn" onclick="checkAnswers()"></button>
            <button id="wordbank-btn" class="button" onclick="openWordBank()"></button>
            <button class="button" onclick="switchLanguage('zh')">中文</button>
            <button class="button" onclick="switchLanguage('en')">English</button>
            <button id="restart-btn" class="button" onclick="restartGame()" style="display:none;"></button>
        </div>
        <div id="result" class="result" style="display:none;"></div>
        <div id="answers" class="answers" style="display:none;"></div>
    </div>

    <script>
        let currentLanguage = localStorage.getItem('currentLanguage') || 'zh';

        const translations = {
          zh: {
            title: "單字配對",
            instructions: "點擊或拖放單詞到對應的意思或翻譯區域。",
            submit: "提交",
            undo: "撤銷",
            darkMode: "切換深色/淡色模式",
            wordBank: "查看單字庫",
            restart: "再玩一次",
            correct: "答對",
            incorrect: "答錯",
            correctAnswersTitle: "答案解析：",
            incorrectlyAnsweredTitle: "回答錯誤：",
            unansweredTitle: "未作答：",
            correctShouldBe: "應為",
            noWordsToTest: "沒有單字可供測驗。",
            promptToAddWords: "請點擊「查看單字庫」新增單字。",
            unselected: "未選擇",
            confirmSubmitPartial: "還有 {count} 個空格未填寫，確定要提交嗎？"
          },
          en: {
            title: "Word Matching Game",
            instructions: "Click or drag the words to match their meanings or translations.",
            submit: "Submit",
            undo: "Undo",
            darkMode: "Toggle Dark/Light Mode",
            wordBank: "View Word Bank",
            restart: "Play Again",
            correct: "correct",
            incorrect: "incorrect",
            correctAnswersTitle: "Correct Answers:",
            incorrectlyAnsweredTitle: "Incorrectly Answered:",
            unansweredTitle: "Unanswered:",
            correctShouldBe: "Correct is",
            noWordsToTest: "No words available for testing.",
            promptToAddWords: "Please click \"View Word Bank\" to add words.",
            unselected: "Unselected",
            confirmSubmitPartial: "There are {count} empty spaces. Are you sure you want to submit?"
          }
        };

        let isFirstRound = true;

        let settings = JSON.parse(localStorage.getItem('wordGameSettings')) || {
            wordsPerRound: 10,
            enableWeightSystem: true
        };

        let wordsTestedInSession = new Set();
        let totalUniqueWords = 0;

        let currentRoundWords = [];
        let selectedWord = null;
        const actionHistory = [];

        function initializeOrUpdateWords(wordsArray) {
            return wordsArray.map(wordItem => {
                return {
                    word: wordItem.word,
                    translation: wordItem.translation,
                    wrongCount: wordItem.wrongCount !== undefined ? wordItem.wrongCount : 0,
                    correctCount: wordItem.correctCount !== undefined ? wordItem.correctCount : 0,
                    hasBeenTested: wordItem.hasBeenTested !== undefined ? wordItem.hasBeenTested : false,
                    streakCount: wordItem.streakCount !== undefined ? wordItem.streakCount : 0,
                    score: wordItem.score !== undefined ? wordItem.score : 0
                };
            });
        }

        function shuffle(array) {
            return array.sort(() => Math.random() - 0.5);
        }

        function calculateWordScore(wordObj, isCorrect) {
            let points = 0;

            if (isCorrect) {
                const streakReward = wordObj.streakCount > 1 ? (wordObj.streakCount - 1) * 10 : 0;
                points = 10 + streakReward;
            } else {
                points = -10;
            }

            return points;
        }

        function createGame() {
            let words = JSON.parse(localStorage.getItem('words')) || [];
            words = initializeOrUpdateWords(words);

            const wordContainer = document.querySelector('.words');
            const targetContainer = document.querySelector('.targets');
            const submitButton = document.getElementById('submit-btn');

            wordContainer.innerHTML = "";
            targetContainer.innerHTML = "";
            selectedWord = null;
            actionHistory.length = 0;

            submitButton.disabled = false;

            totalUniqueWords = new Set(words.map(w => w.word)).size;

            if (words.length === 0) {
                wordContainer.innerHTML = `
                    <p>${translations[currentLanguage].noWordsToTest}</p>
                    <p>${translations[currentLanguage].promptToAddWords}</p>
                `;
                wordContainer.style.display = 'block';
                wordContainer.style.textAlign = 'center';
                document.getElementById('submit-btn').style.display = 'none';
                document.getElementById('restart-btn').style.display = 'none';
                document.getElementById('result').style.display = 'none';
                document.getElementById('answers').style.display = 'none';
                return;
            } else {
                wordContainer.style.display = 'flex';
                wordContainer.style.textAlign = 'initial';
                document.getElementById('submit-btn').style.display = 'inline-block';
            }

            const numWordsForRound = Math.min(settings.wordsPerRound, words.length);
            let wordsToChoose = [...words];

            wordsTestedInSession = new Set(words.filter(w => w.hasBeenTested).map(w => w.word));

            if (!settings.enableWeightSystem) {
                // 沒有權重時，隨機選取單字
                currentRoundWords = shuffle(wordsToChoose).slice(0, numWordsForRound);
            } else {
                // 有權重時，依分數由低到高排序，並選取單字
                const sortedWords = wordsToChoose.sort((a, b) => a.score - b.score);
                currentRoundWords = sortedWords.slice(0, numWordsForRound);
            }

            if (currentRoundWords.length < numWordsForRound && wordsToChoose.length > currentRoundWords.length) {
                const alreadySelectedWords = new Set(currentRoundWords.map(w => w.word));
                const availableWords = wordsToChoose.filter(w => !alreadySelectedWords.has(w.word));
                const wordsToFill = shuffle(availableWords).slice(0, numWordsForRound - currentRoundWords.length);
                currentRoundWords = shuffle([...currentRoundWords, ...wordsToFill]);
            }

            if (currentRoundWords.length === 0 && words.length > 0) {
                 currentRoundWords = shuffle([...words]).slice(0, numWordsForRound);
            }

            currentRoundWords.forEach(wordObj => {
                const originalWordIndex = words.findIndex(w => w.word === wordObj.word);
                if (originalWordIndex !== -1) {
                    words[originalWordIndex].hasBeenTested = true;
                    wordsTestedInSession.add(wordObj.word);
                }
            });
            localStorage.setItem('words', JSON.stringify(words));

            const shuffledWords = shuffle([...currentRoundWords]);
            const shuffledTranslations = shuffle([...currentRoundWords]);


            shuffledWords.forEach(item => {
                const wordDiv = document.createElement('div');
                wordDiv.className = 'word';
                wordDiv.draggable = true;
                wordDiv.textContent = item.word;
                wordDiv.dataset.word = item.word;

                wordDiv.addEventListener('dragstart', dragStart);
                wordDiv.addEventListener('dragend', dragEnd);
                wordDiv.addEventListener('click', handleWordClick);

                wordContainer.appendChild(wordDiv);
            });

            shuffledTranslations.forEach(item => {
                const targetDiv = document.createElement('div');
                targetDiv.className = 'target';
                targetDiv.dataset.translation = item.translation;
                targetDiv.innerHTML = `
                    <div class="moved-word"></div>
                    <div class="original-translation">${item.translation}</div>
                    <button class="delete-btn" onclick="deleteWord(event, this)">×</button>
                `;
                targetDiv.addEventListener('dragover', allowDrop);
            targetDiv.addEventListener('drop', drop);
            targetDiv.addEventListener('click', () => matchWord(targetDiv));

                targetContainer.appendChild(targetDiv);
            });

            document.getElementById('undo-btn').style.display = 'inline-block';
            document.getElementById('dark-mode-btn').style.display = 'inline-block';
            document.getElementById('wordbank-btn').style.display = 'inline-block';
            document.querySelector('button[onclick="switchLanguage(\'zh\')"]').style.display = (currentLanguage === 'zh' ? 'none' : 'inline-block');
            document.querySelector('button[onclick="switchLanguage(\'en\')"]').style.display = (currentLanguage === 'en' ? 'none' : 'inline-block');

            document.getElementById('restart-btn').style.display = 'none';
        }
        function switchLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('currentLanguage', lang);
            const t = translations[currentLanguage];

            document.title = t.title;
            document.getElementById('title').textContent = t.title;
            document.getElementById('instructions').textContent = t.instructions;
            document.getElementById('submit-btn').textContent = t.submit;
            document.getElementById('undo-btn').textContent = t.undo;
            document.getElementById('dark-mode-btn').textContent = t.darkMode;
            document.getElementById('wordbank-btn').textContent = t.wordBank;
            document.getElementById('restart-btn').textContent = t.restart;

            document.querySelector('button[onclick="switchLanguage(\'zh\')"]').style.display = (lang === 'zh' ? 'none' : 'inline-block');
            document.querySelector('button[onclick="switchLanguage(\'en\')"]').style.display = (lang === 'en' ? 'none' : 'inline-block');

            createGame();

            const rulesIframe = document.getElementById('rulesModal').querySelector('iframe');
            if (rulesIframe && rulesIframe.contentWindow) {
                rulesIframe.contentWindow.postMessage({ type: 'languageChange', lang: lang }, '*');
            }
        }

        function allowDrop(e) {
            e.preventDefault();
        }

        function dragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.word);
        }

        function dragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function drop(e) {
            e.preventDefault();
            const word = e.dataTransfer.getData('text/plain');
            handleAction(e.target, word);
        }

        function speakWord(text) {
            if (!text || !window.speechSynthesis) return;
            const synth = window.speechSynthesis;
            if (synth.speaking) synth.cancel();
            const utter = new SpeechSynthesisUtterance(text);
            const hasLatin = /[a-zA-Z]/.test(text);
            utter.lang = hasLatin ? 'en-US' : 'zh-TW';
            utter.rate = 0.95;
            utter.pitch = 1;
            synth.speak(utter);
        }

        function handleWordClick(event) {
            const wordElement = event.target;
            // 檢查單字是否已被使用，如果是，則不執行任何操作
            if (wordElement.classList.contains('used')) {
                return;
            }
            speakWord(wordElement.dataset.word || wordElement.textContent);
            selectWord(wordElement);
        }

        function selectWord(wordElement) {
            if (selectedWord) {
                selectedWord.classList.remove('selected');
            }
            if (selectedWord === wordElement) {
                selectedWord = null;
            } else {
                selectedWord = wordElement;
                selectedWord.classList.add('selected');
            }
        }

        function matchWord(targetElement) {
            if (selectedWord) {
                handleAction(targetElement, selectedWord.dataset.word);
            }
        }

        function handleAction(targetElement, word) {
            const actualTarget = targetElement.closest('.target');
            if (!actualTarget) return;

            const movedWordDiv = actualTarget.querySelector('.moved-word');
            const oldWord = actualTarget.dataset.droppedWord || null;

            actionHistory.push({ target: actualTarget, oldWord: oldWord, newWord: word });

            if (oldWord) {
                enableWord(oldWord);
            }
            movedWordDiv.textContent = word;
            disableWord(word);

            actualTarget.dataset.droppedWord = word;
            toggleDeleteButton(actualTarget);

            if (selectedWord) {
                selectedWord.classList.remove('selected');
                selectedWord = null;
            }
        }

        function toggleDeleteButton(targetElement) {
            const deleteButton = targetElement.querySelector('.delete-btn');
            if (targetElement.dataset.droppedWord) {
                targetElement.classList.add('has-word');
            } else {
                targetElement.classList.remove('has-word');
            }
        }

        function undoLastAction() {
            if (actionHistory.length === 0) return;
            const lastAction = actionHistory.pop();
            const { target, oldWord, newWord } = lastAction;

            const movedWordDiv = target.querySelector('.moved-word');
            if (newWord) {
                enableWord(newWord);
            }
            if (oldWord) {
                disableWord(oldWord);
                target.dataset.droppedWord = oldWord;
                movedWordDiv.textContent = oldWord;
            } else {
                delete target.dataset.droppedWord;
                movedWordDiv.textContent = "";
            }
            toggleDeleteButton(target);
        }

        function enableWord(word) {
            const wordDiv = document.querySelector(`.word[data-word="${word}"]`);
            if (wordDiv) {
                wordDiv.classList.remove('used');
                wordDiv.classList.remove('paired');
                wordDiv.draggable = true;
            }
        }

        function disableWord(word) {
            const wordDiv = document.querySelector(`.word[data-word="${word}"]`);
            if (wordDiv) {
                wordDiv.classList.add('used');
                wordDiv.classList.add('paired');
                wordDiv.draggable = false;
            }
        }

        function deleteWord(event, button) {
            event.stopPropagation();
            const target = button.closest('.target');
            const currentWord = target.dataset.droppedWord;
            if (currentWord) {
                enableWord(currentWord);
            }
            delete target.dataset.droppedWord;
            target.querySelector('.moved-word').textContent = "";
            toggleDeleteButton(target);
        }

        function resetGameUI() {
            document.querySelectorAll('.target').forEach(target => {
                target.querySelector('.moved-word').textContent = "";
                delete target.dataset.droppedWord;
                target.classList.remove('correct', 'incorrect');
                toggleDeleteButton(target);
                target.addEventListener('dragover', allowDrop);
                target.addEventListener('drop', drop);
                target.addEventListener('click', () => matchWord(target));
            });
            document.querySelectorAll('.word').forEach(word => {
                word.classList.remove('used');
                word.draggable = true;
            });

            document.getElementById('result').style.display = 'none';
            document.getElementById('answers').style.display = 'none';

            document.getElementById('submit-btn').disabled = false;
            document.getElementById('undo-btn').style.display = 'inline-block';
            document.getElementById('dark-mode-btn').style.display = 'inline-block';
            document.getElementById('wordbank-btn').style.display = 'inline-block';
            document.querySelector('button[onclick="switchLanguage(\'zh\')"]').style.display = (currentLanguage === 'zh' ? 'none' : 'inline-block');
            document.querySelector('button[onclick="switchLanguage(\'en\')"]').style.display = (currentLanguage === 'en' ? 'none' : 'inline-block');

            document.getElementById('restart-btn').style.display = 'none';
        }


        function checkAnswers() {
            let words = JSON.parse(localStorage.getItem('words')) || [];
            words = initializeOrUpdateWords(words);

            const targetElements = document.querySelectorAll('.target');
            const unfilledTargets = Array.from(targetElements).filter(target => !target.dataset.droppedWord);

            if (unfilledTargets.length > 0) {
                const t = translations[currentLanguage];
                const confirmMessage = t.confirmSubmitPartial.replace('{count}', unfilledTargets.length);
                if (!confirm(confirmMessage)) {
                    return;
                }
            }

            const correctAnswers = [];
            const wrongAnswers = [];

            targetElements.forEach(target => {
                const droppedWord = target.dataset.droppedWord;
                const originalTranslation = target.dataset.translation;
                target.classList.remove('correct', 'incorrect');

                if (droppedWord) {
                    const originalWordIndex = words.findIndex(w => w.word === droppedWord);

                    if (originalWordIndex !== -1) {
                        const originalWordObj = words[originalWordIndex];
                        if (originalWordObj.translation === originalTranslation) {
                            target.classList.add('correct');
                            correctAnswers.push(droppedWord);
                            originalWordObj.correctCount++;
                            originalWordObj.streakCount++;
                            originalWordObj.wrongCount = Math.max(0, originalWordObj.wrongCount - 1);

                            const points = calculateWordScore(originalWordObj, true);
                            originalWordObj.score = Math.max(0, originalWordObj.score + points);
                        } else {
                            target.classList.add('incorrect');
                            wrongAnswers.push(droppedWord);
                            originalWordObj.wrongCount++;
                            originalWordObj.streakCount = 0;

                            const points = calculateWordScore(originalWordObj, false);
                            originalWordObj.score = Math.max(0, originalWordObj.score + points);
                        }
                    }
                } else {
                    target.classList.add('incorrect');
                }
            });

            document.querySelectorAll('.word:not(.used)').forEach(wordDiv => {
                const word = wordDiv.dataset.word;
                const originalWordIndex = words.findIndex(w => w.word === word);
                if (originalWordIndex !== -1) {
                    const wordObj = words[originalWordIndex];
                    wordObj.wrongCount++;
                    wordObj.streakCount = 0;
                    wordObj.score = Math.max(0, wordObj.score - 10);
                }
            });


            localStorage.setItem('words', JSON.stringify(words));

            localStorage.setItem('wordCardUpdated', Date.now().toString());

            const resultDiv = document.getElementById('result');
            const answersDiv = document.getElementById('answers');
            const restartBtn = document.getElementById('restart-btn');

            resultDiv.style.display = 'block';
            answersDiv.style.display = 'block';
            document.getElementById('submit-btn').style.display = 'none';

            document.querySelectorAll('.word').forEach(wordDiv => {
                wordDiv.draggable = false;
                wordDiv.classList.add('used');
                wordDiv.classList.remove('paired');
            });
            document.querySelectorAll('.target').forEach(targetDiv => {
                targetDiv.removeEventListener('drop', drop);
                targetDiv.removeEventListener('dragover', allowDrop);
                targetDiv.removeEventListener('click', matchWord);
                targetDiv.querySelector('.delete-btn').style.display = 'none';
            });

            if (isFirstRound) {
                document.getElementById('wordbank-btn').style.display = 'none';
                isFirstRound = false;
            }

            const t = translations[currentLanguage];
            resultDiv.innerHTML = `<h2>${correctAnswers.length} ${t.correct}, ${wrongAnswers.length + unfilledTargets.length} ${t.incorrect}.</h2>`;

            let answersHTML = '';
            if (wrongAnswers.length > 0 || unfilledTargets.length > 0) {
                answersHTML += `<p><b>${t.correctAnswersTitle}</b></p>`;

                if (wrongAnswers.length > 0) {
                    answersHTML += `<h4>${t.incorrectlyAnsweredTitle}</h4><ul>`;
                    wrongAnswers.forEach(word => {
                        const correctTranslation = words.find(w => w.word === word)?.translation;
                        const wrongTarget = Array.from(targetElements).find(t => t.dataset.droppedWord === word);
                        const userChoiceTranslation = wrongTarget.dataset.translation;

                        answersHTML += `<li><b>${word}</b> &rarr; <s>${userChoiceTranslation}</s> (${t.correctShouldBe}: ${correctTranslation})</li>`;
                    });
                    answersHTML += '</ul>';
                }

                if (unfilledTargets.length > 0) {
                    answersHTML += `<h4>${t.unansweredTitle}</h4><ul>`;
                    unfilledTargets.forEach(target => {
                        const originalTranslation = target.dataset.translation;
                        const correctWord = currentRoundWords.find(w => w.translation === originalTranslation)?.word;
                        if(correctWord) {
                            answersHTML += `<li>${correctWord} : ${originalTranslation}</li>`;
                        }
                    });
                    answersHTML += '</ul>';
                }
            } else {
                answersHTML += `<p>${t.correct === 'correct' ? 'Excellent! All words matched correctly!' : '太棒了！所有單字都答對了！'}</p>`;
            }
            answersDiv.innerHTML = answersHTML;

            restartBtn.style.display = 'inline-block';
            document.getElementById('undo-btn').style.display = 'none';
            document.getElementById('dark-mode-btn').style.display = 'none';
            document.querySelector('button[onclick="switchLanguage(\'zh\')"]').style.display = 'none';
            document.querySelector('button[onclick="switchLanguage(\'en\')"]').style.display = 'none';
        }


        function restartGame() {
            let words = JSON.parse(localStorage.getItem('words')) || [];
            words.forEach(wordItem => {
                wordItem.hasBeenTested = false;
            });
            localStorage.setItem('words', JSON.stringify(words));
            wordsTestedInSession.clear();

            resetGameUI();
            createGame();
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);

            const rulesIframe = document.getElementById('rulesModal').querySelector('iframe');
            if (rulesIframe && rulesIframe.contentWindow) {
                rulesIframe.contentWindow.postMessage({ type: 'darkModeChange', isDark: isDark }, '*');
            }
        }

        function openWordBank() {
            window.open('單字庫.html', '_blank');
        }

        function toggleRules() {
            const modal = document.getElementById('rulesModal');
            modal.style.display = 'block';

            const rulesIframe = document.getElementById('rulesModal').querySelector('iframe');
            if (rulesIframe && rulesIframe.contentWindow) {
                const currentLang = localStorage.getItem('currentLanguage') || 'zh';
                const isDark = localStorage.getItem('darkMode') === 'true';

                rulesIframe.contentWindow.postMessage({ type: 'languageChange', lang: currentLang }, '*');
                rulesIframe.contentWindow.postMessage({ type: 'darkModeChange', isDark: isDark }, '*');
            }
        }

        function closeRules(event) {
            const modal = document.getElementById('rulesModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('rulesModal');
                if (modal.style.display === 'block') {
                    modal.style.display = 'none';
                }
            }
        });

        window.addEventListener('message', function(event) {
            if (event.data.type === 'wordsUpdated') {
                createGame();
            }
        });

        window.addEventListener('storage', function(event) {
            if (event.key === 'wordBankUpdated') {
                createGame();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            currentLanguage = localStorage.getItem('currentLanguage') || 'zh';
            switchLanguage(currentLanguage);

            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            }

            createGame();
        });
    </script>
</body>
</html>
