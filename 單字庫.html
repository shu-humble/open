<!DOCTYPE html>
<html lang="UTF-8">
<head>
  <meta charset="UTF-8">
  <title></title> 
  <style>
  body {
   font-family: Arial, sans-serif;
    margin: 0px 10px 10px 10px;
  }
    .container {
      display: flex;
      gap: 10px;
    }
    .left-panel {
      flex: 1;
    }
    .right-panel {
      flex: 1;
      position: sticky;
      margin-top: -5.0em;
      align-self: flex-start;
    }
    .word-list {
      max-height: 70vh;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
    }
    .word-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px;
      border-bottom: 1px solid #eee;  
    }
    .word-item:last-child {
      border-bottom: none;
    }
    .word-item-info {
        flex-grow: 1; /* 讓信息部分佔據更多空間 */
    }
    .word-item-actions {
        display: flex;
        gap: 5px; /* 按鈕之間的小間距 */
    }
    .save-buttons {
      margin: 20px 0;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 5px;
    }
    .save-buttons button {
      margin-right: 10px;
    }
    button {
    padding: 5px 10px;
    cursor: pointer;
    transition: background-color 0.3s ease, opacity 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    border-radius: 3px;
  }

  .save-button-dirty {
    background-color: #007bff;
    color: white;
    border: 1px solid #0056b3;
    opacity: 1;
  }

  .save-button-clean {
    background-color: #e0e0e0;
    color: #333;
    border: 1px solid #b0b0b0;
    opacity: 0.7;
  }

  .danger-button {
      background-color: red;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
  }
    input[type="text"], input[type="number"] {
      padding: 5px;
      margin: 5px 0;
      width: 200px;
    }
    textarea {
      width: 100%;
      margin: 5px 0;
    }

  </style>
</head>
<body>
  <h1 id="mainTitle"></h1> 
  <p id="saveReminder"></p>  
  <button id="langToggleBtn" onclick="toggleLanguage()">🌐 切換語言</button>
  <div class="container">

    <div class="left-panel">
      <div>
        <h2 id="bulkAndBackupTitle"></h2>
        <textarea id="dataTextarea" rows="10" cols="50"></textarea><br>
        <div>
            <button onclick="bulkImportFromTextarea()" id="bulkImportBtn"></button>
            <button onclick="exportAllData()" id="exportDataBtn"></button>
            <button onclick="importAllData()" id="importDataBtn"></button>
        </div>
      </div>

      <hr>

      <div>
        <h2 id="gameSettingsTitle"></h2>
        <div style="margin-bottom: 10px;">
          <label for="wordsPerRound" id="wordsPerRoundLabel"></label>
          <input type="number" id="wordsPerRound" min="1" value="10">
        </div>
        
        <div style="margin-bottom: 10px;">
          <label>
            <input type="checkbox" id="enableWeightSystem"> 
            <span id="enableWeightSystemLabel"></span>
          </label>
        </div>
        
        <div>
          <button class="button" onclick="resetAllWrongCounts()">
            <span id="resetWeightsButtonText"></span>
          </button>
        </div>
      </div>

      <div class="save-buttons">
        <button id="saveAllButton" onclick="saveAll()"></button> 
        <button class="danger-button" id="clearAllWordsButton" onclick="clearAllWords()"></button>
      </div>

    </div>

    <div class="right-panel">
      <h2 id="wordListSectionTitle"></h2>
      <div style="margin-bottom: 10px;">
          <label for="sortOrder" id="sortOrderLabel"></label>
          <select id="sortOrder" onchange="renderWords()">
              <option value="default" id="sortDefaultOption"></option>
              <option value="accuracy_desc" id="sortAccuracyDescOption"></option>
              <option value="accuracy_asc" id="sortAccuracyAscOption"></option>
          </select>
      </div>
      <div class="word-list" id="wordList"></div>
      <div id="noWordsInWordBankMessage" style="display: none; text-align: center; padding: 20px; color: #666; font-size: 1.1em;">
          <p id="noWordsBankText"></p>
      </div>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    let currentLanguage = urlParams.get('lang') || 'zh';
  
    let words = JSON.parse(localStorage.getItem('words')) || [];
    words = words.map(wordItem => {
        return {
            word: wordItem.word,
            translation: wordItem.translation,
            wrongCount: wordItem.wrongCount !== undefined ? wordItem.wrongCount : 0,
            correctCount: wordItem.correctCount !== undefined ? wordItem.correctCount : 0, 
            hasBeenTested: wordItem.hasBeenTested !== undefined ? wordItem.hasBeenTested : false
        };
    });

    let settings = JSON.parse(localStorage.getItem('wordGameSettings')) || { 
        wordsPerRound: 10,
        enableWeightSystem: true 
    };

    let originalWords;
    let originalSettings;

    let needsSave = false;
    const saveAllButton = document.getElementById('saveAllButton');
    const saveReminderElement = document.getElementById('saveReminder');

    function updateSaveButtonState() {
      const t = translations[currentLanguage];
      if (needsSave) {
        saveAllButton.classList.remove('save-button-clean');
        saveAllButton.classList.add('save-button-dirty');
        saveReminderElement.textContent = t.reminder;
      } else {
        saveAllButton.classList.remove('save-button-dirty');
        saveAllButton.classList.add('save-button-clean');
        saveReminderElement.textContent = '';
      }
    }

    function markAsNeedsSave() {
      const currentWordsString = JSON.stringify(words);
      const currentWordsPerRound = parseInt(document.getElementById('wordsPerRound').value);
      const currentEnableWeightSystem = document.getElementById('enableWeightSystem').checked; 
      
      const currentSettings = { 
          wordsPerRound: currentWordsPerRound,
          enableWeightSystem: currentEnableWeightSystem
      };
      const currentSettingsString = JSON.stringify(currentSettings);

      const originalWordsString = JSON.stringify(originalWords);
      const originalSettingsString = JSON.stringify(originalSettings);

      const hasChanges = (currentWordsString !== originalWordsString) || (currentSettingsString !== originalSettingsString);

      if (hasChanges && !needsSave) {
        needsSave = true;
        updateSaveButtonState();
      } else if (!hasChanges && needsSave) {
        needsSave = false;
        updateSaveButtonState();
      }
    }

    // New function to sort words
    function sortWords(sortOption) {
        if (sortOption === 'accuracy_desc') {
            words.sort((a, b) => {
                const totalA = a.correctCount + a.wrongCount;
                const accuracyA = totalA > 0 ? (a.correctCount / totalA) : 0;
                const totalB = b.correctCount + b.wrongCount;
                const accuracyB = totalB > 0 ? (b.correctCount / totalB) : 0;
                return accuracyB - accuracyA; // Descending
            });
        } else if (sortOption === 'accuracy_asc') {
            words.sort((a, b) => {
                const totalA = a.correctCount + a.wrongCount;
                const accuracyA = totalA > 0 ? (a.correctCount / totalA) : 0;
                const totalB = b.correctCount + b.wrongCount;
                const accuracyB = totalB > 0 ? (b.correctCount / totalB) : 0;
                return accuracyA - accuracyB; // Ascending
            });
        } else {
            // Default sort (e.g., by original input order or alphabetically)
            // For simplicity, we'll keep the current order if no specific sort is chosen
            // Or you could sort alphabetically by word:
            words.sort((a, b) => a.word.localeCompare(b.word));
        }
    }

    function renderWords() {
        const wordList = document.getElementById('wordList');
        const noWordsMessageDiv = document.getElementById('noWordsInWordBankMessage'); 
        const noWordsBankText = document.getElementById('noWordsBankText'); 
        const t = translations[currentLanguage]; 
        
        const sortOption = document.getElementById('sortOrder').value;
        sortWords(sortOption); // Apply sorting before rendering

        if (words.length === 0) {
            wordList.innerHTML = ''; 
            wordList.style.display = 'none'; 
            // 動態獲取標題文本，並插入到提示語中
            const bulkAndBackupTitleText = document.getElementById('bulkAndBackupTitle').textContent;
            noWordsBankText.innerHTML = `${t.noWordsInBank}<br>${t.promptToAddWordsInBankDynamic.replace('{0}', bulkAndBackupTitleText)}`; 
            noWordsMessageDiv.style.display = 'block'; 
        } else {
            noWordsMessageDiv.style.display = 'none'; 
            wordList.style.display = 'block'; 
            wordList.innerHTML = ''; 

            words.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'word-item';

                const totalAttempts = item.correctCount + item.wrongCount;
                const accuracyRate = totalAttempts > 0 ? ((item.correctCount / totalAttempts) * 100).toFixed(0) : 0; 

                const infoSpan = document.createElement('span');
                infoSpan.className = 'word-item-info';
                infoSpan.textContent = `${item.word} - ${item.translation} (${t.accuracyRateLabel} ${accuracyRate}%)`;
                div.appendChild(infoSpan);

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'word-item-actions';

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = t.delete;
                deleteBtn.onclick = () => {
                    words.splice(index, 1);
                    renderWords(); 
                    markAsNeedsSave();
                };
                actionsDiv.appendChild(deleteBtn);

                div.appendChild(actionsDiv);
                wordList.appendChild(div);
            });
        }
    }

    // 輔助函數：更新或新增單字（用於批量匯入英文,中文格式）
    function updateOrCreateWord(newWordObj) {
        const existingIndex = words.findIndex(item => item.word === newWordObj.word);
        if (existingIndex !== -1) {
            // 如果單字已存在，更新其翻譯，並保留原有的答對答錯次數
            // 這裡假設批量匯入時，用戶更希望更新翻譯，而不是重置學習進度
            words[existingIndex].translation = newWordObj.translation;
            return 'updated';
        } else {
            // 如果單字不存在，新增
            words.push(newWordObj);
            return 'added';
        }
    }

    // 將單字匯入和數據備份還原功能合併到一個 textarea
    function bulkImportFromTextarea() {
        const t = translations[currentLanguage];
        const inputText = document.getElementById('dataTextarea').value.trim();
        if (!inputText) {
            alert(t.alertPasteWordsRequired);
            return;
        }
        
        // 檢查是否是 JSON 數據，如果是，提示用戶使用「匯入所有數據」
        try {
            const potentialJson = JSON.parse(inputText);
            if (potentialJson.words && Array.isArray(potentialJson.words)) {
                alert(t.alertUseImportAllData);
                return;
            }
        } catch (e) {
            // 不是 JSON 數據，繼續按批量單字處理
        }

        let addedCount = 0;
        let updatedCount = 0;

        const lines = inputText.split('\n');
        for (const line of lines) {
            const parts = line.split(',').map(s => s.trim());
            if (parts.length >= 2 && parts[0] && parts[1]) {
                const word = parts[0];
                const translation = parts[1];
                // 創建一個新的單字對象，包含默認的計數和狀態
                const newWordObj = { word, translation, wrongCount: 0, correctCount: 0, hasBeenTested: false };
                const status = updateOrCreateWord(newWordObj);
                if (status === 'added') addedCount++;
                else updatedCount++;
            }
        }
        document.getElementById('dataTextarea').value = ''; // 清空 textarea
        renderWords();
        if (addedCount > 0 || updatedCount > 0) {
            markAsNeedsSave();
            alert(`${t.alertBulkImportSummary} ${addedCount} ${t.alertBulkImportAdded}, ${updatedCount} ${t.alertBulkImportUpdated}.`);
        } else {
            alert(t.alertNoValidWordsImported);
        }
    }

    function saveWords() {
        localStorage.setItem('words', JSON.stringify(words));
    }

    function saveSettings() {
        const wordsPerRoundInput = document.getElementById('wordsPerRound');
        const newWordsPerRound = parseInt(wordsPerRoundInput.value); 
        const newEnableWeightSystem = document.getElementById('enableWeightSystem').checked;
        const t = translations[currentLanguage];

        if (isNaN(newWordsPerRound) || newWordsPerRound < 1) {
            alert(t.alertInvalidNumber); 
            wordsPerRoundInput.value = settings.wordsPerRound;
            return; 
        }

        let settingsChanged = false;
        if (settings.wordsPerRound !== newWordsPerRound) {
            settings.wordsPerRound = newWordsPerRound;
            settingsChanged = true;
        }
        if (settings.enableWeightSystem !== newEnableWeightSystem) {
            settings.enableWeightSystem = newEnableWeightSystem;
            settingsChanged = true;
        }

        if (settingsChanged) {
            localStorage.setItem('wordGameSettings', JSON.stringify(settings));
            markAsNeedsSave();
        }
    }

    function clearAllWords() {
        const t = translations[currentLanguage];
        if (confirm(t.confirmDeleteAll)) {
            words = [];
            localStorage.removeItem('words');
            renderWords(); 
            markAsNeedsSave();
            console.log(t.alertDeleteAllDone); 
        }
    }

    function resetAllWrongCounts() { 
        const t = translations[currentLanguage];
        if (confirm(t.confirmResetWeights)) {
            words.forEach(item => {
                item.wrongCount = 0;
                item.correctCount = 0; 
                item.hasBeenTested = false; 
            });
            renderWords();
            markAsNeedsSave();
            console.log(t.alertWeightsReset);
        }
    }

    function saveAll() {
      if (!needsSave) {
        console.log(translations[currentLanguage].alertNoChangesToSave || "沒有變更需要儲存。");
        return;
      }

      saveWords();
      saveSettings();

      originalWords = JSON.parse(JSON.stringify(words));
      originalSettings = JSON.parse(JSON.stringify(settings));

      needsSave = false; 
      updateSaveButtonState(); 
      console.log(translations[currentLanguage].alertSaveDone);
    }

    // --- 數據匯出/匯入功能 (純文字版) ---

    function exportAllData() {
        const t = translations[currentLanguage];
        const data = {
            words: words,
            settings: settings
        };
        const jsonString = JSON.stringify(data, null, 2); // 格式化輸出
        const dataTextarea = document.getElementById('dataTextarea');
        dataTextarea.value = jsonString;
        dataTextarea.select();
        try {
            document.execCommand('copy'); // 嘗試複製到剪貼板
            console.log(t.alertDataCopied);
        } catch (err) {
            console.warn('Unable to copy to clipboard. Please copy manually.');
        }
    }

    function importAllData() {
        const t = translations[currentLanguage];
        const inputText = document.getElementById('dataTextarea').value.trim();
        if (!inputText) {
            alert(t.alertPasteBackupRequired);
            return;
        }
        try {
            const importedData = JSON.parse(inputText);
            applyImportedData(importedData);
            alert(t.alertDataImported);
        } catch (e) {
            alert(t.alertInvalidData);
            console.error("Import error:", e);
        } finally {
            document.getElementById('dataTextarea').value = ''; // 清空 textarea
        }
    }
    
    function applyImportedData(importedData) {
        let currentWordsMap = new Map();
        words.forEach(word => currentWordsMap.set(word.word, word)); // 將現有單字轉為 Map 便於查詢

        // 處理匯入的單字數據
        if (importedData.words && Array.isArray(importedData.words)) {
            importedData.words.forEach(importedWord => {
                const existingWord = currentWordsMap.get(importedWord.word);
                if (existingWord) {
                    // 如果單字已存在，更新其屬性（以匯入數據為準，這是"同步"的邏輯）
                    existingWord.translation = importedWord.translation;
                    existingWord.wrongCount = importedWord.wrongCount !== undefined ? importedWord.wrongCount : 0; 
                    existingWord.correctCount = importedWord.correctCount !== undefined ? importedWord.correctCount : 0; 
                    existingWord.hasBeenTested = importedWord.hasBeenTested !== undefined ? importedWord.hasBeenTested : false; 
                } else {
                    // 如果單字不存在，則新增到 Map (並確保所有屬性都有)
                    currentWordsMap.set(importedWord.word, {
                        word: importedWord.word,
                        translation: importedWord.translation,
                        wrongCount: importedWord.wrongCount !== undefined ? importedWord.wrongCount : 0,
                        correctCount: importedWord.correctCount !== undefined ? importedWord.correctCount : 0,
                        hasBeenTested: importedWord.hasBeenTested !== undefined ? importedWord.hasBeenTested : false
                    });
                }
            });
            words = Array.from(currentWordsMap.values()); // 將 Map 轉回陣列
            localStorage.setItem('words', JSON.stringify(words));
        } else {
            console.warn("Imported data does not contain a valid 'words' array.");
        }

        // 處理匯入的設定數據
        if (importedData.settings && typeof importedData.settings === 'object') {
            settings = {
                wordsPerRound: importedData.settings.wordsPerRound !== undefined ? parseInt(importedData.settings.wordsPerRound) : 10,
                enableWeightSystem: importedData.settings.enableWeightSystem !== undefined ? Boolean(importedData.settings.enableWeightSystem) : true
            };
            localStorage.setItem('wordGameSettings', JSON.stringify(settings));
        } else {
            console.warn("Imported data does not contain valid 'settings' object.");
        }

        document.getElementById('wordsPerRound').value = settings.wordsPerRound;
        document.getElementById('enableWeightSystem').checked = settings.enableWeightSystem;
        renderWords();
        originalWords = JSON.parse(JSON.stringify(words));
        originalSettings = JSON.parse(JSON.stringify(settings));
        needsSave = false; 
        updateSaveButtonState();
    }


    const translations = {
        zh: {
            title: '單字管理後台', // <title> 和 H1 標題
            bulkAndBackupTitle: '單字匯入 / 數據備份與還原', // H2 標題
            bulkTextareaPlaceholder: '請在此輸入「單字,意思或翻譯」格式單字（每行一組），或貼上備份數據...', 
            bulkImportBtn: '批量匯入單字（更新或新增）', 
            exportDataBtn: '匯出所有數據（複製貼上）', 
            importDataBtn: '匯入所有數據（覆蓋與合併）', 
            
            save: '💾儲存所有設定', 
            clear: '❌一鍵刪除所有單字', 
            gameSettingsTitle: '遊戲設定', // H2 標題
            wordsPerRoundLabel: '每局單字數量：', // Label 文字
            enableWeightSystemText: '啟用權重出題系統 (優先考錯的字)', // Span 文字
            resetAllWrongCountsText: '📊 重設所有單字權重', // Span 文字
            wordListSectionTitle: '單字列', // H2 標題
            delete: '刪除',
            reminder: '🔔 您有未儲存的變更！請點擊【💾儲存所有設定】', 
            alertPasteWordsRequired: '請在文字區域輸入或貼上單字！', 
            alertUseImportAllData: '偵測到可能是完整的備份數據。請點擊「匯入所有數據」按鈕。', 
            alertBulkImportSummary: '批量匯入完成！', 
            alertBulkImportAdded: '新增', 
            alertBulkImportUpdated: '更新', 
            alertNoValidWordsImported: '沒有有效單字被匯入或更新。', 
            alertSaveDone: '儲存成功！',
            confirmDeleteAll: '確定要刪除所有單字嗎？這個動作無法復原！',
            alertDeleteAllDone: '已清空所有單字！',
            alertInvalidNumber: '請輸入有效的數字！',
            alertNoChangesToSave: '沒有變更需要儲存。',
            confirmResetWeights: '確定要重設所有單字的錯誤次數（權重）嗎？此動作無法復原！',
            alertWeightsReset: '所有單字的權重已重設。',
            accuracyRateLabel: '答對率:', 
            alertDataCopied: '數據已複製到剪貼板！',
            alertPasteBackupRequired: '請在文字區域貼上備份數據！',
            alertInvalidData: '無效的數據格式！請檢查您貼上的內容是否為正確的 JSON 格式。',
            alertDataImported: '數據匯入成功！',
            // 單字庫頁面專用的無單字提示
            noWordsInBank: '目前單字庫中沒有單字。',
            promptToAddWordsInBankDynamic: '請使用上方「{0}」功能新增單字。', 
            // New sort options
            sortOrderLabel: '排序方式:',
            sortDefaultOption: '預設 (按字母順序)',
            sortAccuracyDescOption: '答對率 (高到低)',
            sortAccuracyAscOption: '答對率 (低到高)',
        },
        en: {
            title: 'Word Management',
            bulkAndBackupTitle: 'Word Import / Data Backup & Restore', 
            bulkTextareaPlaceholder: 'Enter "English,Meaning or Translation" format words here (one per line), or paste backup data...', 
            bulkImportBtn: 'Bulk Import Words (Update or Add)', 
            exportDataBtn: 'Export All Data (Copy/Paste)', 
            importDataBtn: 'Import All Data (Overwrite & Merge)', 

            save: '💾 Save All Settings', 
            clear: '❌ Delete All Words', 
            gameSettingsTitle: 'Game Settings',
            wordsPerRoundLabel: 'Words per round:',
            enableWeightSystemText: 'Enable Weighted Question System (Prioritize incorrect words)',
            resetAllWrongCountsText: '📊 Reset All Word Weights',
            wordListSectionTitle: 'Current Words',
            delete: 'Delete',
            reminder: '🔔 You have unsaved changes! Click 【💾 Save All Settings】', 
            alertPasteWordsRequired: 'Please enter or paste words into the text area!', 
            alertUseImportAllData: 'Detected a complete backup data. Please click "Import All Data" button.', 
            alertBulkImportSummary: 'Bulk import complete!', 
            alertBulkImportAdded: 'added', 
            alertBulkImportUpdated: 'updated', 
            alertNoValidWordsImported: 'No valid words were imported or updated.', 
            alertSaveDone: 'Saved successfully!',
            confirmDeleteAll: 'Are you sure you want to delete all words? This cannot be undone!',
            alertDeleteAllDone: 'All words have been cleared!',
            alertInvalidNumber: 'Please enter a valid number!',
            alertNoChangesToSave: 'No changes to save.',
            confirmResetWeights: 'Are you sure you want to reset all word error counts (weights)? This action cannot be undone!',
            alertWeightsReset: 'All word weights have been reset.',
            accuracyRateLabel: 'Accuracy Rate:', 
            alertDataCopied: 'Data copied to clipboard!',
            alertPasteBackupRequired: 'Please paste backup data into the text area!',
            alertInvalidData: 'Invalid data format! Please check if the content you pasted is in correct JSON format.',
            alertDataImported: 'Data imported successfully!',
            // Word bank page specific no words message
            noWordsInBank: 'No words currently in the word bank.',
            promptToAddWordsInBankDynamic: 'Please use the "{0}" function above to add words.',
            // New sort options
            sortOrderLabel: 'Sort by:',
            sortDefaultOption: 'Default (Alphabetical)',
            sortAccuracyDescOption: 'Accuracy (High to Low)',
            sortAccuracyAscOption: 'Accuracy (Low to High)',
        }
    };

    function toggleLanguage() {
        currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
        updateLanguage();
    }

    function updateLanguage() {
        const t = translations[currentLanguage];
        
        // 修正點：設置頁面 <title> 文字
        document.title = t.title;

        // 設置 H1 標題文字
        document.getElementById('mainTitle').textContent = t.title;

        // 設置「單字匯入 / 數據備份與還原」H2 標題文字
        document.getElementById('bulkAndBackupTitle').textContent = t.bulkAndBackupTitle; 
        document.getElementById('dataTextarea').placeholder = t.bulkTextareaPlaceholder;
        document.getElementById('bulkImportBtn').textContent = t.bulkImportBtn;
        document.getElementById('exportDataBtn').textContent = t.exportDataBtn;
        document.getElementById('importDataBtn').textContent = t.importDataBtn;
        
        // 設置「遊戲設定」H2 標題文字
        document.getElementById('gameSettingsTitle').textContent = t.gameSettingsTitle;
        
        // 設置「每局單字數量」Label 文字
        const wordsPerRoundLabel = document.getElementById('wordsPerRoundLabel');
        if (wordsPerRoundLabel) { // 這裡加了個檢查，確保元素存在再操作
            wordsPerRoundLabel.textContent = t.wordsPerRoundLabel;
        }

        // 設置「啟用權重出題系統」Span 文字
        const enableWeightSystemLabel = document.getElementById('enableWeightSystemLabel');
        if (enableWeightSystemLabel) {
            enableWeightSystemLabel.textContent = t.enableWeightSystemText;
        }
        
        // 設置「重設所有單字權重」Span 文字
        const resetWeightsButtonText = document.getElementById('resetWeightsButtonText');
        if (resetWeightsButtonText) {
            resetWeightsButtonText.textContent = t.resetAllWrongCountsText;
        }
        
        // 設置「單字列」H2 標題文字
        document.getElementById('wordListSectionTitle').textContent = t.wordListSectionTitle;

        // Update sort labels
        document.getElementById('sortOrderLabel').textContent = t.sortOrderLabel;
        document.getElementById('sortDefaultOption').textContent = t.sortDefaultOption;
        document.getElementById('sortAccuracyDescOption').textContent = t.sortAccuracyDescOption;
        document.getElementById('sortAccuracyAscOption').textContent = t.sortAccuracyAscOption;

        // 按鈕文字現在完全由 updateLanguage 函數根據當前語言來設定
        document.getElementById('saveAllButton').textContent = t.save; 
        document.getElementById('clearAllWordsButton').textContent = t.clear; 
        
        document.getElementById('langToggleBtn').textContent = '🌐 ' + (currentLanguage === 'zh' ? 'English' : '中文');
        
        renderWords(); 
        updateSaveButtonState();
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('wordsPerRound').value = settings.wordsPerRound;
        document.getElementById('enableWeightSystem').checked = settings.enableWeightSystem;

        originalWords = JSON.parse(JSON.stringify(words));
        originalSettings = JSON.parse(JSON.stringify(settings));

        document.getElementById('dataTextarea').addEventListener('input', markAsNeedsSave); 
        document.getElementById('wordsPerRound').addEventListener('input', markAsNeedsSave);
        document.getElementById('enableWeightSystem').addEventListener('change', markAsNeedsSave);

        needsSave = false;
        updateLanguage(); 
    });
</script>
</body>
</html>